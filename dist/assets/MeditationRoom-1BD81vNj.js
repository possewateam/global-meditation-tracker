import{u as $,r as i,j as e,F as D,U as E,N as P,k as A,X as H}from"./vendor-react-CsWuKxj5.js";import{s as f}from"./page-admin-DgYsNXAM.js";import{u as z,g as F}from"./index-DwrExZEh.js";import"./vendor-other-D2N4SXMU.js";import"./vendor-three-WWH58ZbN.js";import"./vendor-i18n-CPrbmvBl.js";import"./vendor-supabase-D4rA0elu.js";const B=({videoId:o,title:r,youtubeUrl:s,onStart:m})=>{const{t:l}=$(),[c,u]=i.useState(0),[t,d]=i.useState("");i.useEffect(()=>{b();const n=f.channel(`video-${o}-sessions`).on("postgres_changes",{event:"*",schema:"public",table:"meditation_room_sessions",filter:`video_id=eq.${o}`},()=>{b()}).subscribe(),h=setInterval(()=>{b()},5e3);return()=>{n.unsubscribe(),clearInterval(h)}},[o]),i.useEffect(()=>{const n=N(s);n&&d(`https://img.youtube.com/vi/${n}/hqdefault.jpg`)},[s]);const b=async()=>{const{data:n,error:h}=await f.from("meditation_room_sessions").select("id, last_heartbeat").eq("video_id",o).eq("is_active",!0);if(!h&&n){const w=new Date,y=n.filter(k=>{if(!k.last_heartbeat)return!0;const S=new Date(k.last_heartbeat);return(w.getTime()-S.getTime())/1e3<15});u(y.length)}},N=n=>{if(!n)return null;const h=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/];for(const w of h){const y=n.match(w);if(y&&y[1])return y[1]}return null};return e.jsxs("div",{className:"bg-gradient-to-br from-teal-900/40 to-blue-900/40 backdrop-blur-lg rounded-2xl overflow-hidden shadow-2xl border border-teal-500/20 hover:border-teal-500/40 transition-all duration-300 hover:scale-[1.02]",children:[e.jsxs("div",{className:"relative aspect-video bg-black/50",children:[t?e.jsx("img",{src:t,alt:r,className:"w-full h-full object-cover",onError:n=>{n.currentTarget.style.display="none"}}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(D,{className:"w-16 h-16 text-teal-400 opacity-50"})}),e.jsxs("div",{className:"absolute top-3 right-3 flex items-center gap-2 bg-black/70 backdrop-blur-sm px-3 py-2 rounded-full",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${c>0?"bg-green-400 animate-pulse":"bg-gray-400"}`}),e.jsx(E,{className:"w-4 h-4 text-teal-300"}),e.jsx("span",{className:"text-white font-semibold text-sm",children:c})]})]}),e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-3 line-clamp-2",children:r}),e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-teal-300",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:c===0?l("meditationRoom.noViewers"):c===1?l("meditationRoom.oneViewer"):l("meditationRoom.viewersCount",{count:c})})]})}),e.jsxs("button",{onClick:m,className:"w-full flex items-center justify-center gap-3 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold hover:shadow-lg hover:shadow-green-500/50 transition-all duration-300",children:[e.jsx(D,{className:"w-5 h-5"}),l("meditationRoom.startButton")]})]})]})},Z=({startTime:o})=>{const[r,s]=i.useState(0);i.useEffect(()=>{const l=()=>{const u=new Date(o),d=Math.floor((new Date().getTime()-u.getTime())/1e3);s(d)};l();const c=setInterval(l,1e3);return()=>clearInterval(c)},[o]);const m=l=>{const c=Math.floor(l/60),u=l%60;return`${String(c).padStart(2,"0")}:${String(u).padStart(2,"0")}`};return e.jsx("span",{className:"text-green-400 font-mono font-semibold",children:m(r)})},J=({videoId:o,videoTitle:r})=>{const{t:s}=$(),[m,l]=i.useState([]);i.useEffect(()=>{c();const t=f.channel(`video-${o}-meditators`).on("postgres_changes",{event:"*",schema:"public",table:"meditation_room_sessions",filter:`video_id=eq.${o}`},()=>{c()}).subscribe(),d=setInterval(()=>{c()},5e3);return()=>{t.unsubscribe(),clearInterval(d)}},[o]);const c=async()=>{const{data:t,error:d}=await f.from("meditation_room_sessions").select(`
        id,
        name,
        location,
        latitude,
        longitude,
        start_time,
        last_heartbeat,
        user_id,
        users (
          city_town,
          district,
          state,
          country,
          bk_centre_name
        )
      `).eq("video_id",o).eq("is_active",!0).order("start_time",{ascending:!1});if(!d&&t){const b=new Date,N=t.filter(n=>{if(!n.last_heartbeat)return!0;const h=new Date(n.last_heartbeat);return(b.getTime()-h.getTime())/1e3<15}).map(n=>{const h=Array.isArray(n.users)?n.users[0]:n.users;return{...n,city_town:h?.city_town||null,district:h?.district||null,state:h?.state||null,country:h?.country||null,bk_centre_name:h?.bk_centre_name||null}});l(N)}},u=t=>{const d=[];return t.city_town&&d.push(t.city_town),t.district&&t.district!==t.city_town&&d.push(t.district),t.state&&d.push(t.state),t.country&&d.push(t.country),d.length>0?d.join(", "):t.location||"Unknown"};return m.length===0?null:e.jsxs("div",{className:"bg-gradient-to-br from-teal-900/40 to-blue-900/40 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-teal-500/20",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(E,{className:"w-6 h-6 text-green-400"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full"})]}),e.jsxs("h2",{className:"text-xl font-bold text-white",children:[s("meditationRoom.watchingNow")," - ",r]})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-green-500/20 px-4 py-2 rounded-full border border-green-400/40",children:[e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),e.jsx("span",{className:"text-green-300 font-bold text-lg",children:m.length})]})]}),e.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto custom-scrollbar",children:m.map(t=>{const d=u(t),b=!!t.user_id;return e.jsx("div",{className:"bg-white/5 backdrop-blur-sm rounded-lg p-4 border border-teal-400/20 hover:border-teal-400/40 transition-all duration-300",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-semibold text-white text-lg",children:t.name||s("common.anonymous")}),b&&e.jsx("span",{className:"px-2 py-0.5 bg-green-500/20 text-green-300 text-xs rounded-full border border-green-400/30",children:"Registered"})]}),t.bk_centre_name&&e.jsx("p",{className:"text-teal-200 text-sm font-medium mb-1",children:t.bk_centre_name}),e.jsxs("div",{className:"flex items-start gap-1",children:[e.jsx(P,{className:"w-4 h-4 text-teal-300 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-teal-300 text-sm",children:d})]}),t.latitude&&t.longitude&&e.jsxs("div",{className:"text-teal-400/60 text-xs mt-1",children:[t.latitude.toFixed(4),"°, ",t.longitude.toFixed(4),"°"]})]}),e.jsx(Z,{startTime:t.start_time})]})},t.id)})}),e.jsx("div",{className:"mt-6 pt-4 border-t border-teal-500/20",children:e.jsxs("p",{className:"text-sm text-teal-300 text-center",children:[m.length," ",m.length===1?s("meditators.person"):s("meditators.people")," ",s("meditationRoom.watchingThisVideo")]})})]})},G=({sessionId:o,startTime:r,isActive:s,onStop:m})=>{const l=i.useRef(null),c=i.useRef(null);i.useEffect(()=>{if(s&&o){localStorage.setItem("activeRoomSession",JSON.stringify({sessionId:o,startTime:r?.toISOString()})),l.current=setInterval(async()=>{await f.from("meditation_room_sessions").update({last_heartbeat:new Date().toISOString()}).eq("id",o).eq("is_active",!0)},5e3);const u=()=>{c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{m()},100)};return window.addEventListener("beforeunload",u),()=>{l.current&&clearInterval(l.current),c.current&&clearTimeout(c.current),window.removeEventListener("beforeunload",u)}}else localStorage.removeItem("activeRoomSession"),l.current&&(clearInterval(l.current),l.current=null)},[s,o,r,m]),i.useEffect(()=>{const u=async()=>{document.visibilityState==="hidden"&&s&&o&&await f.from("meditation_room_sessions").update({last_heartbeat:new Date().toISOString()}).eq("id",o).eq("is_active",!0)};return document.addEventListener("visibilitychange",u),()=>{document.removeEventListener("visibilitychange",u)}},[s,o]),i.useEffect(()=>()=>{s&&o&&m()},[])},se=({onBack:o})=>{const{t:r}=$(),{user:s}=z(),[m,l]=i.useState([]),[c,u]=i.useState(!0),[t,d]=i.useState(null),[b,N]=i.useState(!1),[n,h]=i.useState(null),[w,y]=i.useState(null),[k,S]=i.useState(!1),[T,V]=i.useState("");i.useEffect(()=>{q(),M();const a=f.channel("room-videos-changes").on("postgres_changes",{event:"*",schema:"public",table:"meditation_room_videos"},()=>{q()}).subscribe(),x=setInterval(async()=>{await f.rpc("cleanup_stale_room_sessions")},1e4);return()=>{a.unsubscribe(),clearInterval(x)}},[]);const M=async()=>{const a=localStorage.getItem("activeRoomSession");if(a)try{const{sessionId:x,startTime:p}=JSON.parse(a),v=new Date(p),g=new Date,R=Math.floor((g.getTime()-v.getTime())/1e3);await f.from("meditation_room_sessions").update({end_time:g.toISOString(),duration_seconds:R,is_active:!1,last_heartbeat:g.toISOString()}).eq("id",x).eq("is_active",!0),localStorage.removeItem("activeRoomSession")}catch{localStorage.removeItem("activeRoomSession")}},q=async()=>{u(!0);const{data:a,error:x}=await f.from("meditation_room_videos").select("*").eq("is_active",!0).order("display_order",{ascending:!0});!x&&a&&l(a),u(!1)},O=a=>{d(a),s?I(a):S(!0)},I=async a=>{const x=s?s.name:T||r("common.anonymous");let p,v,g;if(s&&s.latitude&&s.longitude){p=s.latitude,v=s.longitude;const j=[];s.city_town&&j.push(s.city_town),s.district&&s.district!==s.city_town&&j.push(s.district),s.state&&j.push(s.state),s.country&&j.push(s.country),g=j.length>0?j.join(", "):s.bk_centre_name||"Unknown"}else{const j={name:x,countryCode:s?.country_code,stateCode:s?.state_code,city:s?.city_town},_=await F(j);p=_.lat,v=_.lng,g=_.city&&_.country?`${_.city}, ${_.country}`:_.city||s?.bk_centre_name||"Unknown"}const{data:R,error:L}=await f.from("meditation_room_sessions").insert({video_id:a.id,name:x,user_id:s?.id||null,location:g,latitude:p,longitude:v,start_time:new Date().toISOString(),is_active:!0,last_heartbeat:new Date().toISOString()}).select().single();!L&&R&&(h(R.id),N(!0),y(new Date),S(!1))},C=async()=>{if(!n)return;const a=new Date,x=w?Math.floor((a.getTime()-w.getTime())/1e3):0;await f.from("meditation_room_sessions").update({end_time:a.toISOString(),duration_seconds:x,is_active:!1,last_heartbeat:a.toISOString()}).eq("id",n),N(!1),h(null),y(null),d(null)};G({sessionId:n,startTime:w,isActive:b,onStop:C});const U=a=>{if(!a)return"";if(a.includes("embed")){const v=a.includes("?")?"&":"?";return b?`${a}${v}autoplay=1&mute=0`:`${a}${v}autoplay=0`}const x=/(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/,p=a.match(x);if(p&&p[1]){const g=`https://www.youtube.com/embed/${p[1]}`;return b?`${g}?autoplay=1&mute=0`:`${g}?autoplay=0`}return""};return c?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-900 via-teal-800 to-emerald-900 flex items-center justify-center",children:e.jsx("div",{className:"text-white text-xl",children:r("common.loading")})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-900 via-teal-800 to-emerald-900 text-white",children:[e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("button",{onClick:o,className:"flex items-center gap-2 text-teal-300 hover:text-teal-200 transition-colors mb-4",children:[e.jsx(A,{className:"w-5 h-5"}),r("common.backToDashboard")]}),e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 via-cyan-400 to-blue-400",children:r("meditationRoom.title")}),e.jsx("p",{className:"text-lg text-teal-300",children:r("meditationRoom.subtitle")})]})]}),m.length===0?e.jsxs("div",{className:"max-w-2xl mx-auto bg-gradient-to-br from-teal-900/40 to-blue-900/40 backdrop-blur-lg rounded-2xl p-12 shadow-2xl border border-teal-500/20 text-center",children:[e.jsx(D,{className:"w-16 h-16 text-teal-400 mx-auto mb-4 opacity-50"}),e.jsx("h3",{className:"text-2xl font-bold mb-2",children:r("meditationRoom.noVideos")}),e.jsx("p",{className:"text-teal-300",children:r("meditationRoom.noVideosDescription")})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",children:m.map(a=>e.jsx(B,{videoId:a.id,title:a.title,youtubeUrl:a.youtube_url,onStart:()=>O(a)},a.id))})]}),k&&t&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-teal-900 to-blue-900 rounded-2xl p-8 max-w-md w-full shadow-2xl border border-teal-500/30",children:[e.jsx("h3",{className:"text-2xl font-bold mb-4",children:r("meditationRoom.joinTitle")}),e.jsx("p",{className:"text-teal-300 mb-6",children:r("meditationRoom.joinDescription")}),e.jsx("input",{type:"text",value:T,onChange:a=>V(a.target.value),placeholder:r("meditation.namePlaceholder"),className:"w-full px-4 py-3 bg-white/10 border border-teal-500/30 rounded-lg text-white placeholder-teal-400 focus:outline-none focus:border-teal-500 transition-colors mb-6",onKeyPress:a=>a.key==="Enter"&&t&&I(t)}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:()=>t&&I(t),className:"flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold hover:shadow-lg hover:shadow-green-500/50 transition-all duration-300",children:r("meditation.startButton")}),e.jsx("button",{onClick:()=>{S(!1),d(null)},className:"flex-1 py-3 bg-white/10 text-white rounded-lg font-semibold hover:bg-white/20 transition-all duration-300",children:r("common.cancel")})]})]})}),b&&t&&e.jsx("div",{className:"fixed inset-0 bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 z-50 overflow-y-auto",children:e.jsxs("div",{className:"w-full max-w-7xl my-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:t.title}),e.jsxs("button",{onClick:C,className:"flex items-center gap-2 px-6 py-3 bg-red-500/20 hover:bg-red-500/30 text-red-300 hover:text-red-200 rounded-lg font-semibold transition-all border border-red-500/30",children:[e.jsx(H,{className:"w-5 h-5"}),r("meditation.stop")]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx("div",{className:"aspect-video rounded-lg overflow-hidden shadow-2xl",children:e.jsx("iframe",{src:U(t.youtube_url),title:t.title,className:"w-full h-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0})})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(J,{videoId:t.id,videoTitle:t.title})})]})]})})]})};export{se as MeditationRoom};
