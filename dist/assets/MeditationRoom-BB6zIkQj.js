var e=Object.defineProperty,__name=(t,s)=>e(t,"name",{value:s,configurable:!0});import{u as t,r as s,j as a,F as n,U as o,N as i,k as r,X as l}from"./vendor-react-B3cVin9Q.js";import{s as c}from"./page-admin-cU6anLI0.js";import{u as d,g as m}from"./index-BxZ87--W.js";import"./vendor-other-D9QTidg2.js";import"./vendor-three-DgmlkwHn.js";import"./vendor-i18n-DgyYewF3.js";import"./vendor-supabase-BYHeWUli.js";const u=__name(({videoId:e,title:i,youtubeUrl:r,onStart:l})=>{const{t:d}=t(),[m,u]=s.useState(0),[x,h]=s.useState("");s.useEffect(()=>{b();const t=c.channel(`video-${e}-sessions`).on("postgres_changes",{event:"*",schema:"public",table:"meditation_room_sessions",filter:`video_id=eq.${e}`},()=>{b()}).subscribe(),s=setInterval(()=>{b()},5e3);return()=>{t.unsubscribe(),clearInterval(s)}},[e]),s.useEffect(()=>{const e=g(r);e&&h(`https://img.youtube.com/vi/${e}/hqdefault.jpg`)},[r]);const b=__name(async()=>{const{data:t,error:s}=await c.from("meditation_room_sessions").select("id, last_heartbeat").eq("video_id",e).eq("is_active",!0);if(!s&&t){const e=new Date,s=t.filter(t=>{if(!t.last_heartbeat)return!0;const s=new Date(t.last_heartbeat);return(e.getTime()-s.getTime())/1e3<15});u(s.length)}},"fetchActiveCount"),g=__name(e=>{if(!e)return null;const t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/];for(const s of t){const t=e.match(s);if(t&&t[1])return t[1]}return null},"extractYoutubeVideoId");return a.jsxs("div",{className:"bg-gradient-to-br from-teal-900/40 to-blue-900/40 backdrop-blur-lg rounded-2xl overflow-hidden shadow-2xl border border-teal-500/20 hover:border-teal-500/40 transition-all duration-300 hover:scale-[1.02]",children:[a.jsxs("div",{className:"relative aspect-video bg-black/50",children:[x?a.jsx("img",{src:x,alt:i,className:"w-full h-full object-cover",onError:__name(e=>{e.currentTarget.style.display="none"},"onError")}):a.jsx("div",{className:"w-full h-full flex items-center justify-center",children:a.jsx(n,{className:"w-16 h-16 text-teal-400 opacity-50"})}),a.jsxs("div",{className:"absolute top-3 right-3 flex items-center gap-2 bg-black/70 backdrop-blur-sm px-3 py-2 rounded-full",children:[a.jsx("div",{className:"w-2 h-2 rounded-full "+(m>0?"bg-green-400 animate-pulse":"bg-gray-400")}),a.jsx(o,{className:"w-4 h-4 text-teal-300"}),a.jsx("span",{className:"text-white font-semibold text-sm",children:m})]})]}),a.jsxs("div",{className:"p-6",children:[a.jsx("h3",{className:"text-xl font-bold text-white mb-3 line-clamp-2",children:i}),a.jsx("div",{className:"flex items-center justify-between mb-4",children:a.jsxs("div",{className:"flex items-center gap-2 text-teal-300",children:[a.jsx(o,{className:"w-4 h-4"}),a.jsx("span",{className:"text-sm",children:0===m?d("meditationRoom.noViewers"):1===m?d("meditationRoom.oneViewer"):d("meditationRoom.viewersCount",{count:m})})]})}),a.jsxs("button",{onClick:l,className:"w-full flex items-center justify-center gap-3 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold hover:shadow-lg hover:shadow-green-500/50 transition-all duration-300",children:[a.jsx(n,{className:"w-5 h-5"}),d("meditationRoom.startButton")]})]})]})},"MeditationRoomVideoCard"),x=__name(({startTime:e})=>{const[t,n]=s.useState(0);return s.useEffect(()=>{const t=__name(()=>{const t=new Date(e),s=Math.floor(((new Date).getTime()-t.getTime())/1e3);n(s)},"updateDuration");t();const s=setInterval(t,1e3);return()=>clearInterval(s)},[e]),a.jsx("span",{className:"text-green-400 font-mono font-semibold",children:__name(e=>{const t=Math.floor(e/60),s=e%60;return`${String(t).padStart(2,"0")}:${String(s).padStart(2,"0")}`},"formatTime")(t)})},"LiveTimer"),h=__name(({videoId:e,videoTitle:n})=>{const{t:r}=t(),[l,d]=s.useState([]);s.useEffect(()=>{m();const t=c.channel(`video-${e}-meditators`).on("postgres_changes",{event:"*",schema:"public",table:"meditation_room_sessions",filter:`video_id=eq.${e}`},()=>{m()}).subscribe(),s=setInterval(()=>{m()},5e3);return()=>{t.unsubscribe(),clearInterval(s)}},[e]);const m=__name(async()=>{const{data:t,error:s}=await c.from("meditation_room_sessions").select("\n        id,\n        name,\n        location,\n        latitude,\n        longitude,\n        start_time,\n        last_heartbeat,\n        user_id,\n        users (\n          city_town,\n          district,\n          state,\n          country,\n          bk_centre_name\n        )\n      ").eq("video_id",e).eq("is_active",!0).order("start_time",{ascending:!1});if(!s&&t){const e=new Date,s=t.filter(t=>{if(!t.last_heartbeat)return!0;const s=new Date(t.last_heartbeat);return(e.getTime()-s.getTime())/1e3<15}).map(e=>{const t=Array.isArray(e.users)?e.users[0]:e.users;return{...e,city_town:t?.city_town||null,district:t?.district||null,state:t?.state||null,country:t?.country||null,bk_centre_name:t?.bk_centre_name||null}});d(s)}},"fetchActiveMeditators"),u=__name(e=>{const t=[];return e.city_town&&t.push(e.city_town),e.district&&e.district!==e.city_town&&t.push(e.district),e.state&&t.push(e.state),e.country&&t.push(e.country),t.length>0?t.join(", "):e.location||"Unknown"},"formatDetailedLocation");return 0===l.length?null:a.jsxs("div",{className:"bg-gradient-to-br from-teal-900/40 to-blue-900/40 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-teal-500/20",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"relative",children:[a.jsx(o,{className:"w-6 h-6 text-green-400"}),a.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-ping"}),a.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full"})]}),a.jsxs("h2",{className:"text-xl font-bold text-white",children:[r("meditationRoom.watchingNow")," - ",n]})]}),a.jsxs("div",{className:"flex items-center gap-2 bg-green-500/20 px-4 py-2 rounded-full border border-green-400/40",children:[a.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),a.jsx("span",{className:"text-green-300 font-bold text-lg",children:l.length})]})]}),a.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto custom-scrollbar",children:l.map(e=>{const t=u(e),s=!!e.user_id;return a.jsx("div",{className:"bg-white/5 backdrop-blur-sm rounded-lg p-4 border border-teal-400/20 hover:border-teal-400/40 transition-all duration-300",children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("p",{className:"font-semibold text-white text-lg",children:e.name||r("common.anonymous")}),s&&a.jsx("span",{className:"px-2 py-0.5 bg-green-500/20 text-green-300 text-xs rounded-full border border-green-400/30",children:"Registered"})]}),e.bk_centre_name&&a.jsx("p",{className:"text-teal-200 text-sm font-medium mb-1",children:e.bk_centre_name}),a.jsxs("div",{className:"flex items-start gap-1",children:[a.jsx(i,{className:"w-4 h-4 text-teal-300 flex-shrink-0 mt-0.5"}),a.jsx("span",{className:"text-teal-300 text-sm",children:t})]}),e.latitude&&e.longitude&&a.jsxs("div",{className:"text-teal-400/60 text-xs mt-1",children:[e.latitude.toFixed(4),"°, ",e.longitude.toFixed(4),"°"]})]}),a.jsx(x,{startTime:e.start_time})]})},e.id)})}),a.jsx("div",{className:"mt-6 pt-4 border-t border-teal-500/20",children:a.jsxs("p",{className:"text-sm text-teal-300 text-center",children:[l.length," ",r(1===l.length?"meditators.person":"meditators.people")," ",r("meditationRoom.watchingThisVideo")]})})]})},"ActiveRoomMeditatorsList"),b=__name(({sessionId:e,startTime:t,isActive:a,onStop:n})=>{const o=s.useRef(null),i=s.useRef(null);s.useEffect(()=>{if(a&&e){localStorage.setItem("activeRoomSession",JSON.stringify({sessionId:e,startTime:t?.toISOString()})),o.current=setInterval(async()=>{await c.from("meditation_room_sessions").update({last_heartbeat:(new Date).toISOString()}).eq("id",e).eq("is_active",!0)},5e3);const s=__name(()=>{i.current&&clearTimeout(i.current),i.current=setTimeout(()=>{n()},100)},"handleBeforeUnload");return window.addEventListener("beforeunload",s),()=>{o.current&&clearInterval(o.current),i.current&&clearTimeout(i.current),window.removeEventListener("beforeunload",s)}}localStorage.removeItem("activeRoomSession"),o.current&&(clearInterval(o.current),o.current=null)},[a,e,t,n]),s.useEffect(()=>{const t=__name(async()=>{"hidden"===document.visibilityState&&a&&e&&await c.from("meditation_room_sessions").update({last_heartbeat:(new Date).toISOString()}).eq("id",e).eq("is_active",!0)},"handleVisibilityChange");return document.addEventListener("visibilitychange",t),()=>{document.removeEventListener("visibilitychange",t)}},[a,e]),s.useEffect(()=>()=>{a&&e&&n()},[])},"useMeditationRoomSession"),g=__name(({onBack:e})=>{const{t:o}=t(),{user:i}=d(),[x,g]=s.useState([]),[f,v]=s.useState(!0),[p,w]=s.useState(null),[j,y]=s.useState(!1),[_,N]=s.useState(null),[S,I]=s.useState(null),[k,T]=s.useState(!1),[R,D]=s.useState("");s.useEffect(()=>{$(),E();const e=c.channel("room-videos-changes").on("postgres_changes",{event:"*",schema:"public",table:"meditation_room_videos"},()=>{$()}).subscribe(),t=setInterval(async()=>{await c.rpc("cleanup_stale_room_sessions")},1e4);return()=>{e.unsubscribe(),clearInterval(t)}},[]);const E=__name(async()=>{const e=localStorage.getItem("activeRoomSession");if(e)try{const{sessionId:t,startTime:s}=JSON.parse(e),a=new Date(s),n=new Date,o=Math.floor((n.getTime()-a.getTime())/1e3);await c.from("meditation_room_sessions").update({end_time:n.toISOString(),duration_seconds:o,is_active:!1,last_heartbeat:n.toISOString()}).eq("id",t).eq("is_active",!0),localStorage.removeItem("activeRoomSession")}catch(t){localStorage.removeItem("activeRoomSession")}},"recoverOrphanedSession"),$=__name(async()=>{v(!0);const{data:e,error:t}=await c.from("meditation_room_videos").select("*").eq("is_active",!0).order("display_order",{ascending:!0});!t&&e&&g(e),v(!1)},"fetchVideos"),q=__name(e=>{w(e),i?C(e):T(!0)},"handleStartVideo"),C=__name(async e=>{const t=i?i.name:R||o("common.anonymous");let s,a,n;if(i&&i.latitude&&i.longitude){s=i.latitude,a=i.longitude;const e=[];i.city_town&&e.push(i.city_town),i.district&&i.district!==i.city_town&&e.push(i.district),i.state&&e.push(i.state),i.country&&e.push(i.country),n=e.length>0?e.join(", "):i.bk_centre_name||"Unknown"}else{const e={name:t,countryCode:i?.country_code,stateCode:i?.state_code,city:i?.city_town},o=await m(e);s=o.lat,a=o.lng,n=o.city&&o.country?`${o.city}, ${o.country}`:o.city||i?.bk_centre_name||"Unknown"}const{data:r,error:l}=await c.from("meditation_room_sessions").insert({video_id:e.id,name:t,user_id:i?.id||null,location:n,latitude:s,longitude:a,start_time:(new Date).toISOString(),is_active:!0,last_heartbeat:(new Date).toISOString()}).select().single();!l&&r&&(N(r.id),y(!0),I(new Date),T(!1))},"startMeditationSession"),O=__name(async()=>{if(!_)return;const e=new Date,t=S?Math.floor((e.getTime()-S.getTime())/1e3):0;await c.from("meditation_room_sessions").update({end_time:e.toISOString(),duration_seconds:t,is_active:!1,last_heartbeat:e.toISOString()}).eq("id",_),y(!1),N(null),I(null),w(null)},"handleStopVideo");b({sessionId:_,startTime:S,isActive:j,onStop:O});const V=__name(e=>{if(!e)return"";if(e.includes("embed")){const t=e.includes("?")?"&":"?";return j?`${e}${t}autoplay=1&mute=0`:`${e}${t}autoplay=0`}const t=e.match(/(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);if(t&&t[1]){const e=`https://www.youtube.com/embed/${t[1]}`;return j?`${e}?autoplay=1&mute=0`:`${e}?autoplay=0`}return""},"getEmbedUrl");return f?a.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-900 via-teal-800 to-emerald-900 flex items-center justify-center",children:a.jsx("div",{className:"text-white text-xl",children:o("common.loading")})}):a.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-900 via-teal-800 to-emerald-900 text-white",children:[a.jsxs("div",{className:"container mx-auto px-4 py-8",children:[a.jsxs("div",{className:"mb-8",children:[a.jsxs("button",{onClick:e,className:"flex items-center gap-2 text-teal-300 hover:text-teal-200 transition-colors mb-4",children:[a.jsx(r,{className:"w-5 h-5"}),o("common.backToDashboard")]}),a.jsxs("div",{className:"text-center",children:[a.jsx("h1",{className:"text-4xl md:text-5xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 via-cyan-400 to-blue-400",children:o("meditationRoom.title")}),a.jsx("p",{className:"text-lg text-teal-300",children:o("meditationRoom.subtitle")})]})]}),0===x.length?a.jsxs("div",{className:"max-w-2xl mx-auto bg-gradient-to-br from-teal-900/40 to-blue-900/40 backdrop-blur-lg rounded-2xl p-12 shadow-2xl border border-teal-500/20 text-center",children:[a.jsx(n,{className:"w-16 h-16 text-teal-400 mx-auto mb-4 opacity-50"}),a.jsx("h3",{className:"text-2xl font-bold mb-2",children:o("meditationRoom.noVideos")}),a.jsx("p",{className:"text-teal-300",children:o("meditationRoom.noVideosDescription")})]}):a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",children:x.map(e=>a.jsx(u,{videoId:e.id,title:e.title,youtubeUrl:e.youtube_url,onStart:__name(()=>q(e),"onStart")},e.id))})]}),k&&p&&a.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-gradient-to-br from-teal-900 to-blue-900 rounded-2xl p-8 max-w-md w-full shadow-2xl border border-teal-500/30",children:[a.jsx("h3",{className:"text-2xl font-bold mb-4",children:o("meditationRoom.joinTitle")}),a.jsx("p",{className:"text-teal-300 mb-6",children:o("meditationRoom.joinDescription")}),a.jsx("input",{type:"text",value:R,onChange:__name(e=>D(e.target.value),"onChange"),placeholder:o("meditation.namePlaceholder"),className:"w-full px-4 py-3 bg-white/10 border border-teal-500/30 rounded-lg text-white placeholder-teal-400 focus:outline-none focus:border-teal-500 transition-colors mb-6",onKeyPress:__name(e=>"Enter"===e.key&&p&&C(p),"onKeyPress")}),a.jsxs("div",{className:"flex gap-4",children:[a.jsx("button",{onClick:__name(()=>p&&C(p),"onClick"),className:"flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold hover:shadow-lg hover:shadow-green-500/50 transition-all duration-300",children:o("meditation.startButton")}),a.jsx("button",{onClick:__name(()=>{T(!1),w(null)},"onClick"),className:"flex-1 py-3 bg-white/10 text-white rounded-lg font-semibold hover:bg-white/20 transition-all duration-300",children:o("common.cancel")})]})]})}),j&&p&&a.jsx("div",{className:"fixed inset-0 bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 z-50 overflow-y-auto",children:a.jsxs("div",{className:"w-full max-w-7xl my-8",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-2xl font-bold text-white",children:p.title}),a.jsxs("button",{onClick:O,className:"flex items-center gap-2 px-6 py-3 bg-red-500/20 hover:bg-red-500/30 text-red-300 hover:text-red-200 rounded-lg font-semibold transition-all border border-red-500/30",children:[a.jsx(l,{className:"w-5 h-5"}),o("meditation.stop")]})]}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[a.jsx("div",{className:"lg:col-span-2",children:a.jsx("div",{className:"aspect-video rounded-lg overflow-hidden shadow-2xl",children:a.jsx("iframe",{src:V(p.youtube_url),title:p.title,className:"w-full h-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0})})}),a.jsx("div",{className:"lg:col-span-1",children:a.jsx(h,{videoId:p.id,videoTitle:p.title})})]})]})})]})},"MeditationRoom");export{g as MeditationRoom};
